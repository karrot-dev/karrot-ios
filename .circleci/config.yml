ios-defaults: &ios-defaults
  working_directory: ~/repo
  macos:
    xcode: "10.2.0"
  environment:
    FL_OUTPUT_DIR: output
  shell: /bin/bash --login -eo pipefail

prepare-build-ios: &prepare-build-ios
  command: |
    rm -f cordova/www
    mv dist-app-${CORDOVA_ENV} cordova/www
    cd ~/repo/cordova
    rm -f config/current
    ln -s "${CORDOVA_ENV}" config/current
    cordova platform add ios

version: 2
jobs:
  install-dependencies:
    <<: *defaults
    steps:
      - checkout
      - restore_cache:
          keys:
          - v1-dependencies-{{ checksum "package.json" }}
          - v1-dependencies-
      - run: yarn
      - save_cache:
          paths:
            - node_modules
          key: v1-dependencies-{{ checksum "package.json" }}
      - persist_to_workspace:
          root: ~/repo
          paths:
            - .

  install-fastlane-dependencies:
    <<: *ios-defaults
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - restore_cache:
          key: 1-fastlane-{{ checksum "cordova/Gemfile.lock" }}
      - run:
          name: Install gems
          command: |
            cd ~/repo/cordova/
            bundle check || bundle install --path vendor/cordova
      - save_cache:
          paths:
            - ~/vendor/cordova
          key: 1-fastlane-{{ checksum "cordova/Gemfile.lock" }}

  build-cordova-dev:
    <<: *defaults
    steps:
      - attach_workspace:
          at: .
      - run:
          name: build cordova app
          command: |
            yarn build:cordova:dev
            mv dist dist-app-dev
      - persist_to_workspace:
          root: ~/repo
          paths:
            - dist-app-dev

  build-ios-dev:
    <<: *ios-defaults
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run:
          name: Install cordova
          command: yarn global add cordova
      - run:
          <<: *prepare-build-ios
          name: platform add ios dev
          environment:
            CORDOVA_ENV: dev
      - run:
          name: Build iOS app
          command: |
            cd ~/repo/cordova/
            cordova build ios

  deploy-ios-dev:
    <<: *ios-defaults
    steps:
      - checkout
      - attach_workspace:
          at: .
      - run: yarn global add cordova
      - run:
          <<: *prepare-build-ios
          environment:
            CORDOVA_ENV: dev
      - run:
          command: |
            set -x
            export LC_ALL=C.UTF-8
            export LANG=C.UTF-8
            cd ~/repo/cordova/
            bundle install
            bundle exec fastlane beta

workflows:
  version: 2
  all-the-things:
    jobs:
      - install-dependencies
      - install-fastlane-dependencies
      - build-cordova-dev:
          requires:
            - install-dependencies
      - build-ios-dev:
          requires:
            - build-cordova-dev
            - install-fastlane-dependencies
